# מערכת סליקת אשראי דיאם - תיעוד טכני מקיף

## 🔵 סטטוס מערכת
**✅ פעילה ומחוברה** - מערכת הסליקה עובדת בפועל עם חיבור אמיתי ל-iCount API

**🆕 חדש:** **יצירת חשבוניות עם קבלה אוטומטית** - כל סליקה יוצרת אוטומטית חשבונית מס עם קבלה על סכום הסליקה בפועל

## 🎯 תכונות זמינות

### ✅ תכונות פעילות
- **סליקת כרטיס אשראי אמיתית** דרך iCount API
- **זיהוי אוטומטי של סוג כרטיס** (VISA, MasterCard, AMEX, ישראכארט)
- **תמיכה בשני מתחמים** (רוטשילד ושדה התעופה)
- **יצירת חשבונית עם קבלה אוטומטית** - כל סליקה יוצרת חשבונית מס עם קבלה על הסכום שנסלק
- **גמישות בסכום הסליקה** - ניתן לשנות את סכום הסליקה ללא תלות בסכום ההזמנה
- **מערכת חשבוניות קיימת** נשמרת ללא שינוי (ניתן ליצור חשבוניות ידנית כמו קודם)
- **בדיקות תקינות מקיפות** (מספר כרטיס, תוקף, CVV)
- **טיפול חכם במייל חסר** (שימוש במייל ברירת מחדל)
- **תמיכה בפורמטים שונים של תוקף כרטיס**

### 🔐 אבטחה ואמינות
- **חיבור מוצפן SSL** לשרתי iCount
- **אימות כפול** - גם פרטי המשתמש וגם פרטי החברה
- **תיעוד מלא** של כל העסקאות עם מספרי אישור
- **מעקב אחר שגיאות** ולוגים מפורטים
- **גיבוי של נתוני סליקה** במסד הנתונים המקומי

### 📊 דוחות ומעקב  
- **מספר עסקה ייחודי** לכל סליקה
- **קוד אישור** מ-iCount
- **זיהוי סוג כרטיס** ו-4 ספרות אחרונות
- **חשבונית מס עם קבלה מיידית** עם מספר חשבונית מ-iCount
- **שמירת היסטוריית העסקאות**

### 💳 **חיוב כרטיסי אשראי**
- ✅ חיוב ישיר דרך API של iCount
- ✅ זיהוי אוטומטי של סוג כרטיס (VISA, MasterCard, ישראכארט, AMEX)
- ✅ תמיכה בשני המתחמים (Airport ו-Rothschild)
- ✅ בדיקות תקינות מקיפות
- ✅ טיפול מתקדם בשגיאות

### 🔒 **אבטחה**
- ✅ אימות משתמש נדרש
- ✅ בדיקת תקינות נתוני כרטיס
- ✅ חיבור מוצפן ל-iCount
- ✅ לוגים מפורטים לעקיבה

### 📱 **ממשק משתמש**
- ✅ דיאלוג נקי ומינימלי
- ✅ עריכת סכום חיוב
- ✅ הצגת פרטי כרטיס (מוסתר חלקית)
- ✅ הודעות ברורות על הצלחה/שגיאה

## 🏗️ **ארכיטקטורה**

### **Frontend (קליינט)**
```
client/src/components/payment/
├── CreditCardChargeDialog.js     # דיאלוג הסליקה הראשי
└── services/icountService.js     # שירות קליינט לקריאות API
```

### **Backend (שרת)**
```
server/
├── routes/icount.js              # נתיבי API לסליקה
├── services/icountService.js     # לוגיקת עסקים וחיבור iCount
└── models/Booking.js            # מודל הזמנה עם פרטי כרטיס
```

## 🔧 **הגדרות טכניות**

### **פרטי חיבור iCount**
```javascript
accounts: {
  airport: {
    companyId: process.env.ICOUNT_AIRPORT_COMPANY_ID,
    username: process.env.ICOUNT_AIRPORT_USERNAME,
    password: process.env.ICOUNT_AIRPORT_PASSWORD,
    vatId: process.env.ICOUNT_VAT_ID
  },
  rothschild: {
    companyId: process.env.ICOUNT_ROTHSCHILD_COMPANY_ID,
    username: process.env.ICOUNT_ROTHSCHILD_USERNAME,
    password: process.env.ICOUNT_ROTHSCHILD_PASSWORD,
    vatId: process.env.ICOUNT_VAT_ID
  }
}
```

### **API Endpoint**
- **URL**: `https://api.icount.co.il/api/v3.php/cc/bill`
- **Method**: POST
- **Content-Type**: application/json
- **Timeout**: 30 שניות

## 📋 **זיהוי אוטומטי של כרטיסים**

| סוג כרטיס | התחלת מספר | דוגמה |
|-----------|-------------|--------|
| VISA | 4 | 4580-1234-5678-9012 |
| MasterCard | 5, 2 | 5555-1234-5678-9012 |
| AMEX | 34, 37 | 3782-822463-10005 |
| ישראכארט | 3 (אחר) | 3528-1234-5678-9012 |

## 🔄 **תהליך הסליקה**

1. **בדיקות תקינות**
   - פרטי הזמנה קיימים
   - פרטי כרטיס שלמים ותקינים
   - סכום חיוב תקין

2. **התחברות ל-iCount**
   - אימות עם פרטי החשבון
   - קבלת session ID

3. **זיהוי כרטיס**
   - זיהוי אוטומטי של סוג כרטיס
   - ניקוי מספר כרטיס

4. **ביצוע סליקה**
   - שליחת בקשה ל-iCount API
   - קבלת תוצאות

5. **טיפול בתוצאות**
   - הצגת הודעות למשתמש
   - שמירת לוגים

## 📊 **מבנה נתונים**

### **פרטי כרטיס בהזמנה**
```javascript
creditCard: {
  cardNumber: String,    // מספר כרטיס מלא
  expiryDate: String,    // תוקף בפורמט MM/YY  
  cvv: String           // קוד אבטחה
}
```

### **תגובת הצלחה**
```javascript
{
  success: true,
  transactionId: String,  // מספר עסקה מ-iCount
  amount: Number,         // סכום שנוצק
  cardType: String,       // סוג כרטיס
  last4Digits: String,    // 4 ספרות אחרונות
  message: String         // הודעה למשתמש
}
```

## 🚨 **טיפול בשגיאות**

### **שגיאות נפוצות**
- `נתוני תשלום או הזמנה חסרים` - בעיה בנתונים שנשלחו
- `פרטי כרטיס אשראי חסרים בהזמנה` - הזמנה ללא פרטי כרטיס
- `התחברות ל-iCount נכשלה` - בעיה באימות
- `בעיה בחיבור לשרת iCount` - בעיה ברשת
- `מספר כרטיס אשראי לא תקין` - פורמט כרטיס שגוי

### **לוגים**
כל פעולה מתועדת בקונסול השרת עם רמות חשיבות:
- 🔄 מידע כללי
- 💳 פעולות כרטיס
- 💰 פעולות כספיות  
- ✅ הצלחות
- ❌ שגיאות

## 🔗 **אינטגרציה עם המערכת**

### **כפתורי גישה**
- **טופס הזמנה חדשה**: אייקון כרטיס אשראי ליד אייקון החשבונית
- **פרטי הזמנה**: כפתור "סליקת אשראי" ליד "יצירת מסמך"

### **תנאים להצגה**
הכפתור מוצג רק אם:
- יש פרטי כרטיס אשראי שמורים בהזמנה
- המשתמש מחובר למערכת
- ההזמנה קיימת ותקינה

## 📈 **סטטיסטיקות ומעקב**

- **לוגים מפורטים** בקונסול השרת
- **הודעות למשתמש** על הצלחה/כישלון
- **מספרי עסקה** לכל סליקה מוצלחת
- **זיהוי סוג כרטיס** לסטטיסטיקות

---

## 📞 **תמיכה טכנית**

במקרה של בעיות:
1. בדוק את הלוגים בקונסול השרת
2. וודא חיבור אינטרנט תקין
3. בדוק תקינות פרטי כרטיס בהזמנה
4. נסה שוב לאחר כמה דקות

**הערה**: המערכת מחוברת למסופי הסליקה הפעילים ב-iCount ובדוקה לפעולה. 